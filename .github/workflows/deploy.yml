name: üöÄ Build & Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: production_deploy
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: [self-hosted, linux, x64]
    environment:
      name: production

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üü© Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üì¶ Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: üì• Install dependencies
        # Added prefer-offline to ensure we use the local store first
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: üß™ Run backend tests
        run: |
          echo "üß™ Running backend test suite with coverage..."
          COVERAGE_REPORTERS=text pnpm --filter backend test:coverage
          echo "‚úÖ All backend tests passed with coverage!"
        continue-on-error: false

      - name: üèóÔ∏è Build frontend
        run: pnpm build:frontend
        env:
          VITE_TURNSTILE_SITE_KEY: ${{ secrets.VITE_TURNSTILE_SITE_KEY }}

      - name: üöÄ Deploy backend
        run: |
          BACKEND_PATH="${{ secrets.BACKEND_PATH }}"
          echo "üì§ Copying backend files to $BACKEND_PATH ..."
          mkdir -p "$BACKEND_PATH"
          rsync -az --delete --exclude 'node_modules' --exclude '.git' --exclude '__tests__' --exclude 'coverage' --exclude 'lcov-report' backend/ "$BACKEND_PATH/"
          
          echo "üîë Setting up environment variables..."
          cat > "$BACKEND_PATH/.env" << ENVEOF
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          TURNSTILE_SECRET_KEY=${{ secrets.TURNSTILE_SECRET_KEY }}
          PORT=5000
          NODE_ENV=production
          ENVEOF
          chmod 600 "$BACKEND_PATH/.env"
          
          echo "üöÄ Starting backend with PM2..."
          cd "$BACKEND_PATH"
          
          # Clean node_modules to ensure no corrupted binaries
          rm -rf node_modules
          pnpm install --prod --no-frozen-lockfile --prefer-offline
          
          # Hide 'not found' error if it's a first-time deploy
          pm2 delete "stackconverter-backend" > /dev/null 2>&1 || true
          
          # Start the process fresh
          pm2 start index.js --name "stackconverter-backend"
          pm2 save

      - name: üöÄ Deploy frontend
        run: |
          FRONTEND_PATH="${{ secrets.FRONTEND_PATH }}"
          echo "üì§ Copying frontend build to $FRONTEND_PATH ..."
          mkdir -p "$FRONTEND_PATH"
          rsync -az --delete frontend/dist/ "$FRONTEND_PATH/"

      - name: ‚úÖ Run health check
        run: |
          echo "üîç Polling backend health for 200 OK status..."
          
          # Try to connect every 1s, up to 15 times
          SUCCESS=false
          for i in {1..15}; do
            # Specifically capture the HTTP status code
            STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:5000/ || echo "000")
          
            if [ "$STATUS" -eq 200 ]; then
              echo "‚úÖ Backend healthy (Status 200 OK) after $i seconds!"
              SUCCESS=true
              break
            fi
          
            echo "‚è≥ Attempt $i/15: Status $STATUS, app not ready yet..."
            sleep 1
          done

          if [ "$SUCCESS" = false ]; then
            echo "‚ùå Backend failed to return 200 OK within 15 seconds."
            echo "üìä Last 20 lines of PM2 logs:"
            pm2 logs "stackconverter-backend" --lines 20 --nostream
            exit 1
          fi

          echo "üéâ Deployment Summary:"
          echo "‚úÖ Frontend: https://amiroff.org/stackconverter/"
          echo "‚úÖ Backend: http://localhost:5000 (Internal)"
          echo "‚úÖ PM2 process: online"
          echo ""
          echo "üìù Next steps:"
          echo "1. Check PM2 logs: pm2 logs stackconverter-backend"
          echo "2. Monitor with: pm2 monit"
